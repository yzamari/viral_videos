#!/bin/bash
# Pre-commit hook for ViralAI
# Runs sanity tests before allowing commit

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}üîç Running pre-commit checks...${NC}"

# Check for unstaged changes in tracked files
if ! git diff --quiet; then
    echo -e "${YELLOW}‚ö†Ô∏è  Warning: You have unstaged changes${NC}"
    echo "These changes will NOT be included in the commit"
    echo ""
fi

# Run sanity tests
echo -e "${BLUE}üß™ Running sanity tests...${NC}"
./scripts/run_tests.sh sanity

if [ $? -ne 0 ]; then
    echo -e "${RED}‚ùå Pre-commit tests failed!${NC}"
    echo "Please fix the failing tests before committing"
    exit 1
fi

# Check for code quality issues
echo -e "${BLUE}üîç Checking code quality...${NC}"

# Check for common issues
echo "Checking for common issues..."

# Check for print statements (should use logger)
if grep -r "print(" src/ --include="*.py" | grep -v "# noqa" | grep -v "__str__" | grep -v "__repr__"; then
    echo -e "${YELLOW}‚ö†Ô∏è  Found print statements - consider using logger instead${NC}"
fi

# Check for TODO comments
TODO_COUNT=$(grep -r "TODO" src/ --include="*.py" | wc -l)
if [ $TODO_COUNT -gt 0 ]; then
    echo -e "${YELLOW}‚ÑπÔ∏è  Found $TODO_COUNT TODO comments${NC}"
fi

# Check for hardcoded values (basic check)
if grep -r "localhost\|127\.0\.0\.1" src/ --include="*.py" | grep -v "# noqa" | grep -v "test_"; then
    echo -e "${YELLOW}‚ö†Ô∏è  Found hardcoded localhost/IP addresses${NC}"
fi

echo -e "${GREEN}‚úÖ Pre-commit checks passed!${NC}"
exit 0